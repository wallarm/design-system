# Simple Docker Compose for local E2E testing
# This runs only Playwright in Docker against locally running apps

services:
  playwright-design-system:
    image: mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION:-1.58.0}-noble
    working_dir: /app
    shm_size: '2gb'
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
      - playwright_cache:/ms-playwright
      # Map test directories for screenshot updates
      - ./packages/design-system/src:/app/packages/design-system/src:delegated
      - ./packages/design-system/test-results:/app/packages/design-system/test-results:delegated
      - ./packages/design-system/playwright-report:/app/packages/design-system/playwright-report:delegated
    environment:
      - NODE_ENV=test
      - CI=false
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - PLAYWRIGHT_ARGS
    network_mode: host
    command:
      - sh
      - -c
      - |
        echo 'Setting up pnpm...' &&
        npm install -g pnpm@10.29.3 &&
        echo 'Installing dependencies...' &&
        pnpm install --frozen-lockfile &&
        echo 'Installing Playwright browsers...' &&
        pnpm --filter=@wallarm-org/design-system exec playwright install --with-deps chromium &&
        echo 'Running Design System E2E tests...' &&
        if [ -z "${PLAYWRIGHT_ARGS}" ]; then
          pnpm --filter=@wallarm-org/design-system exec playwright test --config=playwright.config.docker.ts --project=chromium;
        else
          echo "Running tests for: ${PLAYWRIGHT_ARGS}" &&
          pnpm --filter=@wallarm-org/design-system exec playwright test --config=playwright.config.docker.ts --project=chromium ${PLAYWRIGHT_ARGS};
        fi
    profiles:
      - design-system

  playwright-design-system-update:
    image: mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION:-1.58.0}-noble
    working_dir: /app
    shm_size: '2gb'
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
      - playwright_cache:/ms-playwright
      # Map test directories for screenshot updates
      - ./packages/design-system/src:/app/packages/design-system/src:delegated
      - ./packages/design-system/test-results:/app/packages/design-system/test-results:delegated
      - ./packages/design-system/playwright-report:/app/packages/design-system/playwright-report:delegated
    environment:
      - NODE_ENV=test
      - CI=false
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - PLAYWRIGHT_ARGS
    network_mode: host
    command:
      - sh
      - -c
      - |
        echo 'Setting up pnpm...' &&
        npm install -g pnpm@10.29.3 &&
        echo 'Installing dependencies...' &&
        pnpm install --frozen-lockfile &&
        echo 'Installing Playwright browsers...' &&
        pnpm --filter=@wallarm-org/design-system exec playwright install --with-deps chromium &&
        echo 'Updating Design System E2E screenshots...' &&
        if [ -z "${PLAYWRIGHT_ARGS}" ]; then
          pnpm --filter=@wallarm-org/design-system exec playwright test --config=playwright.config.docker.ts --project=chromium --update-snapshots;
        else
          echo "Updating screenshots for: ${PLAYWRIGHT_ARGS}" &&
          pnpm --filter=@wallarm-org/design-system exec playwright test --config=playwright.config.docker.ts --project=chromium ${PLAYWRIGHT_ARGS} --update-snapshots;
        fi
    profiles:
      - design-system-update

  playwright-all:
    image: mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION:-1.58.0}-noble
    working_dir: /app
    shm_size: '2gb'
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
      - playwright_cache:/ms-playwright
    environment:
      - NODE_ENV=test
      - CI=false
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - PLAYWRIGHT_ARGS
    network_mode: host
    command:
      - sh
      - -c
      - |
        echo 'Setting up pnpm...' &&
        npm install -g pnpm@10.29.3 &&
        echo 'Installing dependencies...' &&
        pnpm install --frozen-lockfile &&
        echo 'Installing Playwright browsers...' &&
        pnpm --filter=@wallarm-org/design-system exec playwright install --with-deps chromium &&
        echo 'Running all E2E tests...' &&
        if [ -z "${PLAYWRIGHT_ARGS}" ]; then
          pnpm --filter=@wallarm-org/design-system exec playwright test --config=playwright.config.docker.ts;
        else
          echo "Running tests for: ${PLAYWRIGHT_ARGS}" &&
          pnpm --filter=@wallarm-org/design-system exec playwright test --config=playwright.config.docker.ts ${PLAYWRIGHT_ARGS};
        fi
    profiles:
      - all

volumes:
  node_modules:
    driver: local
  playwright_cache:
    driver: local
