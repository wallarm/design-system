name: CI/CD Pipeline

on:
  push:
    branches: [main, 'feature/*', 'tests/*']
  pull_request:
    branches: [main]

concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write
  issues: write

env:
  NODE_VERSION: "24"
  PNPM_VERSION: "10.22.0"
  SCREENSHOT_COMMIT_MESSAGE: "ðŸ–¼ï¸ Update screenshots"

jobs:
  # ========================================
  # Setup & Check Triggers
  # ========================================
  setup:
    name: Setup & Check Triggers
    runs-on: ubuntu-latest
    outputs:
      should-update-screenshots: ${{ steps.check-screenshots.outputs.should_update }}
      is-bot-screenshot-commit: ${{ steps.check-bot.outputs.is_bot }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if bot screenshot commit
        id: check-bot
        run: |
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [[ "$COMMIT_AUTHOR" == "github-actions[bot]" && "$COMMIT_MSG" == "${{ env.SCREENSHOT_COMMIT_MESSAGE }}" ]]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "âœ… Bot screenshot commit detected - will skip E2E tests"
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Check screenshot update trigger
        id: check-screenshots
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [[ "$COMMIT_MSG" == *"[update-screenshots]"* ]]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "âœ… [update-screenshots] trigger found"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

  # ========================================
  # PR Title Check
  # ========================================
  check-pr-title:
    name: Check PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR title format
        uses: thehanimo/pr-title-checker@v1.4.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          configuration_path: .github/pr-title-checker-config.json

  # ========================================
  # Quality Checks (Parallel)
  # ========================================
  quality:
    name: Quality Check - ${{ matrix.check }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check: [lint, typecheck, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

  # ========================================
  # Build
  # ========================================
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Build Storybook
        run: pnpm --filter=@wallarm/design-system build-storybook

      - name: Upload Storybook artifact
        uses: actions/upload-artifact@v4
        with:
          name: storybook-static
          path: packages/design-system/storybook-static
          retention-days: 7

      - name: Upload built packages artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-packages
          path: |
            packages/*/dist
            packages/configs/*/dist
          retention-days: 1

  # ========================================
  # E2E Tests
  # ========================================
  e2e:
    name: E2E Tests (shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      github.event_name == 'pull_request' &&
      needs.setup.outputs.is-bot-screenshot-commit != 'true' &&
      needs.setup.outputs.should-update-screenshots != 'true'
    strategy:
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build config packages
        run: pnpm --filter="./packages/configs/*" build

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: packages/design-system/storybook-static

      - name: Serve Storybook & Run E2E tests
        run: |
          # Set up directory structure for serving with /design-system/ base path
          mkdir -p storybook-serve/design-system
          cp -r packages/design-system/storybook-static/* storybook-serve/design-system/

          # Start HTTP server for Storybook
          npx http-server storybook-serve -p 6006 &

          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:6006/design-system/iframe.html; do sleep 1; done'

          # Run E2E tests
          pnpm --filter=@wallarm/design-system exec playwright test --shard=${{ matrix.shard }}/3 --project=chromium
        env:
          CI: true
          STORYBOOK_URL: http://localhost:6006/design-system

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: packages/design-system/test-results/

  # ========================================
  # E2E Update Screenshots
  # ========================================
  e2e-update-screenshots:
    name: Update Screenshots (shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      github.event_name == 'push' &&
      needs.setup.outputs.should-update-screenshots == 'true'
    strategy:
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build config packages
        run: pnpm --filter="./packages/configs/*" build

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: packages/design-system/storybook-static

      - name: Update screenshots
        run: |
          # Set up directory structure for serving with /design-system/ base path
          mkdir -p storybook-serve/design-system
          cp -r packages/design-system/storybook-static/* storybook-serve/design-system/

          # Start HTTP server for Storybook
          npx http-server storybook-serve -p 6006 &

          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:6006/design-system/iframe.html; do sleep 1; done'

          # Unset CI to allow snapshot creation
          unset CI

          # Update screenshots (exit code ignored - new snapshots cause non-zero exit)
          pnpm --filter=@wallarm/design-system exec playwright test \
            --shard=${{ matrix.shard }}/3 \
            --project=chromium \
            --update-snapshots || true
        env:
          STORYBOOK_URL: http://localhost:6006/design-system

      - name: Upload updated screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-shard-${{ matrix.shard }}
          path: |
            packages/design-system/src/**/*.png
            packages/design-system/tests/**/*.png
          retention-days: 1

  # ========================================
  # Commit Updated Screenshots
  # ========================================
  commit-screenshots:
    name: Commit Updated Screenshots
    runs-on: ubuntu-latest
    needs: [e2e-update-screenshots]
    if: always() && needs.e2e-update-screenshots.result == 'success'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Download all screenshot artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: screenshots-shard-*
          merge-multiple: true

      - name: Check for changes
        id: changes
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No screenshot changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Screenshot changes detected:"
            git diff --cached --name-only
          fi

      - name: Commit and push screenshots
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "${{ env.SCREENSHOT_COMMIT_MESSAGE }}" --no-verify
          git push

  # ========================================
  # Release
  # ========================================
  release:
    name: Release Packages
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      github.event_name == 'push' &&
      needs.setup.outputs.is-bot-screenshot-commit != 'true' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/feature/'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download built packages artifact
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: .

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Release with Semantic Release
        run: |
          # Use multi-semantic-release for monorepo
          npx multi-semantic-release --sequential-init
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ========================================
  # Deploy Storybook to GitHub Pages
  # ========================================
  deploy-storybook:
    name: Deploy Storybook
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      needs.setup.outputs.is-bot-screenshot-commit != 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: ./storybook-static

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./storybook-static

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4