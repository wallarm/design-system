name: CI/CD Pipeline

on:
  push:
    branches: ['**']

concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write
  issues: write

env:
  HUSKY: "0"
  NODE_VERSION: "24"
  PNPM_VERSION: "10.29.3"
  SCREENSHOT_COMMIT_MESSAGE: "ðŸ–¼ï¸ Update screenshots"
  ALLURE_ENDPOINT: ${{ vars.ALLURE_ENDPOINT }}
  ALLURE_PROJECT_ID: ${{ vars.ALLURE_PROJECT_ID }}
  ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
  ALLURE_RESULTS: ${{ secrets.ALLURE_RESULTS }}

jobs:
  # ========================================
  # Setup & Check Triggers
  # ========================================
  setup:
    name: Setup & Check Triggers
    runs-on: ubuntu-latest
    outputs:
      should-update-screenshots: ${{ steps.check-screenshots.outputs.should_update }}
      is-bot-screenshot-commit: ${{ steps.check-bot.outputs.is_bot }}
      should-skip-e2e: ${{ steps.check-e2e-skip.outputs.should_skip }}
      should-release-mcp: ${{ steps.check-mcp.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if bot screenshot commit
        id: check-bot
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            COMMIT_AUTHOR=$(git log ${{ github.event.pull_request.head.sha }} -1 --pretty=%an)
            COMMIT_MSG=$(git log ${{ github.event.pull_request.head.sha }} -1 --pretty=%B)
          else
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
          fi

          if [[ "$COMMIT_AUTHOR" == "github-actions[bot]" && "$COMMIT_MSG" == "${{ env.SCREENSHOT_COMMIT_MESSAGE }}" ]]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "âœ… Bot screenshot commit detected - will skip E2E tests"
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Check screenshot update trigger
        id: check-screenshots
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            COMMIT_MSG=$(git log ${{ github.event.pull_request.head.sha }} -1 --pretty=%B)
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
          fi

          if [[ "$COMMIT_MSG" == *"[update-screenshots]"* ]]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "âœ… [update-screenshots] trigger found"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Check E2E skip trigger
        id: check-e2e-skip
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            COMMIT_MSG=$(git log ${{ github.event.pull_request.head.sha }} -1 --pretty=%B)
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
          fi

          if [[ "$COMMIT_MSG" == *"[skip-e2e]"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "âœ… [skip-e2e] trigger found - will skip E2E tests"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check MCP release trigger
        id: check-mcp
        run: |
          SHOULD_RELEASE="false"

          # Check for breaking change in commit messages since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            RANGE="${LAST_TAG}..HEAD"
          else
            RANGE="HEAD~10..HEAD"
          fi

          # Detect breaking changes (feat!:, fix!:, BREAKING CHANGE in body)
          if git log "$RANGE" --pretty="%B" | grep -qE "^(feat|fix|refactor|perf)(\(.+\))?!:|BREAKING CHANGE"; then
            echo "ðŸ”¥ Breaking change detected â€” MCP release triggered"
            SHOULD_RELEASE="true"
          fi

          # Detect changes in mcp-core or mcp packages
          if [ -n "$LAST_TAG" ]; then
            CHANGED_FILES=$(git diff --name-only "$LAST_TAG"..HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi

          if echo "$CHANGED_FILES" | grep -qE "^packages/(mcp-core|mcp)/"; then
            echo "ðŸ“¦ MCP package changes detected â€” MCP release triggered"
            SHOULD_RELEASE="true"
          fi

          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

  # ========================================
  # Quality Checks (Parallel)
  # ========================================
  quality:
    name: Quality Check - ${{ matrix.check }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check: [lint, typecheck, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

  # ========================================
  # Build
  # ========================================
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Build Storybook
        run: pnpm --filter=@wallarm-org/design-system build-storybook

      - name: Upload Storybook artifact
        uses: actions/upload-artifact@v4
        with:
          name: storybook-static
          path: packages/design-system/storybook-static
          retention-days: 7

      - name: Upload built packages artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-packages
          path: |
            packages/*/dist
            packages/configs/*/dist
          retention-days: 1

  # ========================================
  # E2E Tests
  # ========================================
  e2e:
    name: E2E Tests (shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      needs.setup.outputs.is-bot-screenshot-commit != 'true' &&
      needs.setup.outputs.should-update-screenshots != 'true' &&
      needs.setup.outputs.should-skip-e2e != 'true'
    strategy:
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build config packages
        run: pnpm --filter="./packages/configs/*" build

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Install Playwright system deps
        run: pnpm exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: Install allurectl
        run: |
          wget -qO allurectl https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/

      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: packages/design-system/storybook-static

      - name: Serve Storybook & Run E2E tests
        run: |
          # Set up directory structure for serving with /design-system/ base path
          mkdir -p storybook-serve/design-system
          cp -r packages/design-system/storybook-static/* storybook-serve/design-system/

          # Start HTTP server for Storybook
          npx http-server storybook-serve -p 6006 &

          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:6006/design-system/iframe.html; do sleep 1; done'

          # Run E2E tests with Allure reporting
          cd packages/design-system
          if [ -n "$ALLURE_TOKEN" ]; then
            export ALLURE_LAUNCH_NAME="${{ github.ref_name }} #${{ github.run_number }} shard-${{ matrix.shard }}"
            allurectl watch -- pnpm exec playwright test --shard=${{ matrix.shard }}/3 --project=chromium
          else
            pnpm exec playwright test --shard=${{ matrix.shard }}/3 --project=chromium
          fi
        env:
          CI: true
          STORYBOOK_URL: http://localhost:6006/design-system

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: packages/design-system/test-results/
          if-no-files-found: ignore

  # ========================================
  # E2E Update Screenshots
  # ========================================
  e2e-update-screenshots:
    name: Update Screenshots (shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should-update-screenshots == 'true'
    strategy:
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build config packages
        run: pnpm --filter="./packages/configs/*" build

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Install Playwright system deps
        run: pnpm exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: packages/design-system/storybook-static

      - name: Update screenshots
        run: |
          # Set up directory structure for serving with /design-system/ base path
          mkdir -p storybook-serve/design-system
          cp -r packages/design-system/storybook-static/* storybook-serve/design-system/

          # Start HTTP server for Storybook
          npx http-server storybook-serve -p 6006 &

          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:6006/design-system/iframe.html; do sleep 1; done'

          # Unset CI to allow snapshot creation
          unset CI

          # Update screenshots (exit code ignored - new snapshots cause non-zero exit)
          pnpm --filter=@wallarm-org/design-system exec playwright test \
            --shard=${{ matrix.shard }}/3 \
            --project=chromium \
            --update-snapshots || true
        env:
          STORYBOOK_URL: http://localhost:6006/design-system

      - name: Upload updated screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-shard-${{ matrix.shard }}
          path: |
            packages/design-system/src/**/*.png
            packages/design-system/tests/**/*.png
          retention-days: 1

  # ========================================
  # Commit Updated Screenshots
  # ========================================
  commit-screenshots:
    name: Commit Updated Screenshots
    runs-on: ubuntu-latest
    needs: [e2e-update-screenshots]
    if: always() && needs.e2e-update-screenshots.result == 'success'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Download all screenshot artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: screenshots-shard-*
          merge-multiple: true
          path: packages/design-system

      - name: Check for changes
        id: changes
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No screenshot changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Screenshot changes detected:"
            git diff --cached --name-only
          fi

      - name: Commit and push screenshots
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "${{ env.SCREENSHOT_COMMIT_MESSAGE }}"
          git push

  # ========================================
  # Deploy Storybook to GitHub Pages
  # ========================================
  deploy-storybook:
    name: Deploy Storybook
    runs-on: ubuntu-latest
    needs: [setup, build, e2e]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped') &&
      needs.setup.outputs.is-bot-screenshot-commit != 'true' &&
      needs.setup.outputs.should-update-screenshots != 'true' &&
      github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: ./storybook-static

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./storybook-static

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ========================================
  # Release
  # ========================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [setup, build, e2e]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped') &&
      needs.setup.outputs.is-bot-screenshot-commit != 'true' &&
      needs.setup.outputs.should-update-screenshots != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/configs/*/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download built packages artifact
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: .

      - name: Release design-system
        run: pnpm semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Release mcp
        if: needs.setup.outputs.should-release-mcp == 'true'
        working-directory: packages/mcp
        run: pnpm semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
